<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Tải lên tài liệu - tailieuUNETI</title>
  <link rel="icon" href="assets/favicon.ico?v=2">
  <style>
    :root{
      --plate-r: clamp(22px, 2.8vw, 28px);
      --radius-sm: clamp(12px, 1.6vw, 14px);
      --glass-border-strong: rgba(255,255,255,.14);
      --shadow-strong: 0 14px 30px rgba(0,0,0,.32), 0 3px 8px rgba(0,0,0,.12);
      --gutter: clamp(20px, 6vw, 36px);
      --header-h: clamp(56px, 7vh, 72px);
      --s-2: clamp(14px, 2.8vw, 18px);
      --s-3: clamp(18px, 3.6vw, 24px);
      --text:#eaf2ff;
      --muted: rgba(255,255,255,0.78);
      --brand: #007aff;
      --bg-img: url("assets/A.jpeg");
      --glass-border: rgba(255,255,255,.18);
    }
    *{box-sizing:border-box}
    html{height:100%; overflow-x:hidden; scroll-behavior:smooth;}
    body{ height:100%; margin:0; background-color: #0a0f25; color:var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    .page-wrapper { background: var(--bg-img) center/cover fixed no-repeat; position: relative; z-index: 1; overflow-y: auto; min-height: 100vh; }
    .page-wrapper::before { content: ""; position: absolute; inset: 0; pointer-events: none; background: radial-gradient(140% 100% at 50% 0%, rgba(255,255,255,.06), transparent 60%), radial-gradient(120% 120% at 50% 120%, rgba(0,0,0,.22), transparent 55%), linear-gradient(0deg, rgba(16,22,40,.28), rgba(16,22,40,.28)); backdrop-filter: blur(16px) saturate(160%); -webkit-backdrop-filter: blur(16px) saturate(160%); z-index: -1; }
    .container{max-width: var(--maxw, 1120px); margin-inline: auto; padding-inline: var(--gutter);}
    header{ position: sticky; top: 0; z-index:1000; height:var(--header-h); border-bottom:1px solid var(--glass-border); background: rgba(0,0,0,0.1); backdrop-filter: blur(10px) saturate(140%); -webkit-backdrop-filter: blur(10px) saturate(140%); }
    .nav{height:100%; display:flex; align-items:center; justify-content:space-between;}
    .brand{display:flex; align-items:center; gap:10px; text-decoration:none; color:inherit}
    .brand-logo{height: clamp(36px, 4.6vw, 52px); width:auto; object-fit:contain}
    .brand-name{font-weight:800; font-size: clamp(18px, 2.2vw, 28px); color:#fff}
    .main-content { min-height: calc(100vh - var(--header-h)); display: grid; place-items: center; padding: var(--gutter); }
    .upload-card { width: 100%; max-width: 520px; padding: clamp(24px, 6vw, 40px); border-radius: var(--plate-r); border:1px solid var(--glass-border-strong); background: linear-gradient(to bottom right, rgba(30,30,30,.2), rgba(20,20,20,.1)); box-shadow: var(--shadow-strong); backdrop-filter: blur(20px) saturate(180%); -webkit-backdrop-filter: blur(20px) saturate(180%); }
    .upload-card h1 { text-align: center; font-size: clamp(28px, 5vw, 36px); margin: 0 0 var(--s-3) 0; }
    .upload-form { display: flex; flex-direction: column; gap: var(--s-2); }
    .form-group { display: flex; flex-direction: column; text-align: left; }
    .form-group label { font-size: 0.9em; font-weight: 500; margin-bottom: 8px; color: var(--muted); }
    .form-input { height: clamp(48px, 6vh, 54px); padding: 0 18px; border-radius: var(--radius-sm); border: 1px solid rgba(255,255,255,.3); background: rgba(255,255,255,0.15); color: #fff; font-size: 1em; font-weight: 500; outline: none; transition: border-color .2s ease, box-shadow .2s ease; }
    textarea.form-input { resize: none; }
    .form-input:focus { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3); }
    .btn-primary { height: clamp(50px, 6vh, 56px); border-radius: var(--radius-sm); border: none; background: linear-gradient(135deg, #0077ff, #005fcc); color: #fff; font-size: 1.1em; font-weight: 600; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15); box-shadow: 0 4px 12px rgba(0, 122, 255, 0.2), inset 0 1px 1px rgba(255, 255, 255, 0.15); cursor: pointer; transition: all .2s ease-out; margin-top: 15px; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 18px rgba(0, 122, 255, 0.3); background: linear-gradient(135deg, #0081ff, #006ae6); }
    .btn-primary:active { transform: scale(0.98); box-shadow: 0 2px 8px rgba(0, 122, 255, 0.25); transition-duration: .1s; }
    .form-message { text-align: center; padding: 10px; margin-top: 15px; border-radius: var(--radius-sm); font-size: 0.9em; display: none; }
    .form-message.success { background-color: rgba(45, 201, 109, 0.2); color: #36d87d; display: block; }
    .form-message.error { background-color: rgba(235, 87, 87, 0.2); color: #eb5757; display: block; }
    .form-select-hidden { display: none; }
    .custom-select-wrapper { position: relative; width: 100%; font-weight: 500; }
    .custom-select-trigger { position: relative; display: flex; justify-content: space-between; align-items: center; padding: 0 18px; height: clamp(48px, 6vh, 54px); border-radius: var(--radius-sm); border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.15); color: #fff; font-size: 1em; cursor: pointer; transition: border-color .2s ease, box-shadow .2s ease; }
    .custom-select-wrapper.open .custom-select-trigger { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3); }
    .arrow { position: relative; width: 12px; height: 12px; border-right: 2px solid var(--muted); border-bottom: 2px solid var(--muted); transform: translateY(-25%) rotate(45deg); transition: transform .2s ease; }
    .custom-select-wrapper.open .arrow { transform: translateY(0%) rotate(225deg); }
    
    /* === BẮT ĐẦU: CSS HIỆU ỨNG DROPDOWN MƯỢT MÀ (Bản nâng cấp) === */
    .custom-options {
        position: absolute;
        top: calc(100% + 8px);
        left: 0;
        right: 0;
        z-index: 10;
        background: #FFFFFF;
        border: 1px solid rgba(0, 0, 0, 0.1);
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25);
        border-radius: 14px;
        padding: 6px;
        overflow: hidden;
        opacity: 0;
        visibility: hidden;
        pointer-events: none;
        transform: translateY(-10px);
        transform-origin: top center;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .custom-select-wrapper.open .custom-options {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
        transform: translateY(0);
    }
    /* === KẾT THÚC: CSS HIỆU ỨNG DROPDOWN MƯỢT MÀ === */

    .custom-option { padding: 10px 12px; cursor: pointer; transition: background-color .2s ease; text-align: left; color: #1d1d1f; border-radius: 9px; }
    .custom-option:hover { background-color: rgba(0, 0, 0, 0.05); }
    .custom-option.selected { background-color: rgba(0, 122, 255, 0.15); font-weight: 500; }
    .file-upload-wrapper { position: relative; width: 100%; height: clamp(48px, 6vh, 54px); }
    .file-upload-input { position: absolute; inset: 0; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 10; }
    .file-upload-button { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; gap: 10px; padding: 0 18px; border-radius: var(--radius-sm); border: 1px solid rgba(255, 255, 255, 0.3); background: rgba(255, 255, 255, 0.15); color: var(--muted); font-size: 1em; font-weight: 500; pointer-events: none; transition: all .2s ease; overflow: hidden; white-space: nowrap; }
    .file-upload-wrapper:hover .file-upload-button { border-color: var(--brand); color: #fff; }
    #file-list-container { display: flex; flex-direction: column; gap: 10px; margin-top: var(--s-2); max-height: 220px; overflow-y: auto; padding-right: 5px; }
    .file-list-item { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-radius: var(--radius-sm); background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); animation: fadeIn 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .file-info { display: flex; align-items: center; gap: 10px; overflow: hidden; }
    .file-icon { width: 24px; height: 24px; flex-shrink: 0; color: var(--muted); }
    .file-details { display: flex; flex-direction: column; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .file-name { font-weight: 500; font-size: 0.9em; color: var(--text); overflow: hidden; text-overflow: ellipsis; }
    .file-remove-btn { display: flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; background: transparent; border: none; cursor: pointer; color: var(--muted); flex-shrink: 0; transition: background-color 0.2s ease, color 0.2s ease; }
    .file-remove-btn:hover { background-color: rgba(255, 255, 255, 0.1); color: #fff; }
    .file-remove-btn svg { width: 14px; height: 14px; }
    .nav-actions { display:flex; align-items:center; gap: 10px; }
    .nav-actions .btn-glass { --h: clamp(40px, 4.6vw, 44px); height: var(--h); padding: 0 clamp(14px, 2vw, 18px); display: inline-flex; align-items: center; justify-content: center; gap: 8px; border-radius: 999px; background-color: rgba(255, 255, 255, 0.12); border: 1px solid rgba(255, 255, 255, 0.2); color: rgba(255, 255, 255, 0.95); font-weight: 500; text-decoration: none; backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); transition: background-color .2s ease, transform .2s ease; cursor: pointer; outline: none; }
    .nav-actions .btn-glass:hover { background-color: rgba(255, 255, 255, 0.2); transform: translateY(-1px); }
    .nav-actions .btn-glass:active { transform: scale(0.97); }
    .btn-glass__icon { width: clamp(18px, 2.2vw, 20px); height: clamp(18px, 2.2vw, 20px); flex-shrink: 0; display: inline-flex; align-items: center; }
    .btn-glass__label { line-height: 1; }
    .user-menu-container { position: relative; }
    .user-menu-dropdown { position: absolute; top: calc(100% + 16px); right: 0; min-width: 240px; padding: 6px; z-index: 1100; background: rgba(245, 245, 247, 0.85); color: #1d1d1f; backdrop-filter: blur(30px) saturate(180%); -webkit-backdrop-filter: blur(30px) saturate(180%); border-radius: 14px; border: 1px solid rgba(0, 0, 0, 0.1); box-shadow: 0 10px 40px rgba(0, 0, 0, 0.25); opacity: 0; visibility: hidden; transform: translateY(-10px) scale(0.95); transform-origin: top right; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); pointer-events: none; }
    .user-menu-dropdown.active { opacity: 1; visibility: visible; transform: translateY(0) scale(1); pointer-events: auto; }
    .user-menu-dropdown a { display: flex; align-items: center; gap: 12px; padding: 10px; color: #1d1d1f; text-decoration: none; border-radius: 9px; font-size: 0.9em; font-weight: 500; transition: background-color .2s ease; text-align: left; cursor: pointer; }
    .user-menu-dropdown a:hover { background-color: rgba(0, 0, 0, 0.05); }
    .user-menu-dropdown hr { border: none; height: 1px; background-color: rgba(0, 0, 0, 0.1); margin: 6px 4px; }
    .nav-actions--logged-out .user-menu-container, .nav-actions--logged-in #loginBtn { display: none; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.2); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); z-index: 2000; display: none; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity .3s ease, visibility .3s ease; padding: var(--gutter); }
    .modal-overlay.active { display: flex; opacity: 1; visibility: visible; }
    .modal-overlay .auth-card { position: relative; width: 100%; max-width: 420px; padding: clamp(30px, 6vw, 42px); background: rgba(255, 255, 255, 0.1); border-radius: var(--plate-r); border: 1px solid var(--glass-border-strong); backdrop-filter: blur(30px) saturate(160%); -webkit-backdrop-filter: blur(30px) saturate(160%); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3); transform: scale(0.95); transition: transform .3s ease; }
    .modal-overlay.active .auth-card { transform: scale(1); }
    .modal-overlay .auth-card h1 { font-size: clamp(24px, 4.5vw, 32px); margin: 0 0 30px; color: #fff; text-align: center; }
    .modal-overlay .auth-form { width: 100%; display: flex; flex-direction: column; gap: 18px; }
    .modal-overlay .form-group label { font-size: 1em; font-weight: 550; color: rgba(255,255,255,.9); margin-bottom: 8px; padding-left: 4px; }
    .modal-overlay .form-input { height: clamp(48px, 6vh, 52px); padding: 0 20px; box-shadow: inset 0 1px 3px rgba(0,0,0,.15); }
    .modal-overlay .form-input:focus { border-color: var(--brand); background: rgba(255,255,255,0.25); box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.3), inset 0 1px 3px rgba(0,0,0,.15); }
    .close-btn { position: absolute; top: var(--s-2); right: var(--s-2); width: clamp(36px, 5vw, 42px); height: clamp(36px, 5vw, 42px); display: flex; align-items: center; justify-content: center; background: transparent; border: none; border-radius: 50%; padding: 0; cursor: pointer; color: rgba(255, 255, 255, 0.7); transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
    .close-btn svg { width: 45%; height: 45%; }
    .close-btn:hover { color: white; background-color: rgba(255, 255, 255, 0.1); transform: scale(1.1); }
    .form-input[type="date"]:invalid { color: rgba(255, 255, 255, 0.65); }
    .form-input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1) opacity(0.65); }
    @media (max-width:560px){ .nav-actions .btn-glass { padding:0 12px } .btn-glass__label{ display:none } .btn-glass__label--user{ display: inline !important; } }
  </style>
</head>
<body>

<div class="page-wrapper">
  <header>
    <div class="container nav">
      <a class="brand" href="index.html" title="Về trang chủ - tailieuUNETI">
        <img class="brand-logo" src="assets/logo.png" alt="tailieuUNETI logo"/>
        <span class="brand-name">tailieuUNETI</span>
      </a>

      <div class="nav-actions">
          <div class="user-menu-container">
            <button type="button" class="btn-glass" id="userMenuBtn">
                <svg class="btn-glass__icon" viewBox="0 0 24 24" aria-hidden="true"><path fill="currentColor" d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4.42 0-8 2.24-8 5v1.5a.5.5 0 0 0 .5.5h15a.5.5 0 0 0 .5-.5V19c0-2.76-3.58-5-8-5Z"/></svg>
                <span class="btn-glass__label btn-glass__label--user"></span>
            </button>
            <div class="user-menu-dropdown" id="userDropdown">
                <a href="#" id="userInfoLink">Thông tin tài khoản</a>
                <a href="#" id="changePasswordLink">Đổi mật khẩu</a>
                <hr>
                <a href="logout.php">Đăng xuất</a>
            </div>
          </div>
      </div>
    </div>
  </header>

  <main class="main-content">
    <section class="upload-card">
      <h1>Tải lên tài liệu</h1>
      <form class="upload-form" id="uploadForm">
        <div class="form-group">
          <label for="doc-title">Tiêu đề tài liệu</label>
          <input type="text" name="title" id="doc-title" class="form-input" required>
        </div>
        <div class="form-group">
          <label for="doc-category">Chọn thể loại</label>
          <select name="the_loai" id="doc-category" class="form-select-hidden" required>
              <option value="">-- Vui lòng chọn --</option>
              <option value="daicuong">Đại cương</option>
              <option value="tailieungoaingu">Tài liệu ngoại ngữ</option>
              <option value="tailieuchuyennganh">Tài liệu chuyên ngành</option>
          </select>
          <div class="custom-select-wrapper">
            <div class="custom-select-trigger">
              <span>-- Vui lòng chọn --</span>
              <div class="arrow"></div>
            </div>
            <div class="custom-options">
              <div class="custom-option" data-value="daicuong">Đại cương</div>
              <div class="custom-option" data-value="tailieungoaingu">Tài liệu ngoại ngữ</div>
              <div class="custom-option" data-value="tailieuchuyennganh">Tài liệu chuyên ngành</div>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="doc-description">Mô tả ngắn</label>
          <textarea name="description" id="doc-description" class="form-input" style="height: 80px; padding-top: 15px;"></textarea>
        </div>
        <div class="form-group">
          <label for="doc-file">Tệp đính kèm</label>
          <div class="file-upload-wrapper">
            <input type="file" name="documentFiles[]" id="doc-file" class="file-upload-input" required multiple>
            <div class="file-upload-button">
              <span>Chọn một hoặc nhiều tệp</span>
            </div>
          </div>
          <div id="file-list-container"></div>
        </div>
        <button type="submit" class="btn-primary">Tải lên</button>
        <div id="upload-message" class="form-message"></div>
      </form>
    </section>
  </main>
</div>

<div class="modal-overlay" id="passwordModalOverlay">
  <section class="auth-card" id="passwordChangeCard">
    <button type="button" class="close-btn" data-close-modal="passwordModalOverlay" aria-label="Đóng">
      <svg viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 1L1 13" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/><path d="M1 1L13 13" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/></svg>
    </button>
    <h1>Đổi mật khẩu</h1>
    <form class="auth-form" id="passwordChangeForm">
      <div class="form-group">
        <label for="old-password">Mật khẩu cũ</label>
        <input type="password" name="old_password" id="old-password" class="form-input" required>
      </div>
      <div class="form-group">
        <label for="new-password">Mật khẩu mới</label>
        <input type="password" name="new_password" id="new-password" class="form-input" required>
      </div>
      <div class="form-group">
        <label for="confirm-new-password">Nhập lại mật khẩu mới</label>
        <input type="password" name="confirm_new_password" id="confirm-new-password" class="form-input" required>
      </div>
      <div id="password-change-message" class="form-message"></div>
      <button type="submit" class="btn-primary">Xác nhận</button>
    </form>
  </section>
</div>

<div class="modal-overlay" id="userInfoModalOverlay">
  <section class="auth-card" id="userInfoCard">
    <button type="button" class="close-btn" data-close-modal="userInfoModalOverlay" aria-label="Đóng">
      <svg viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 1L1 13" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/><path d="M1 1L13 13" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/></svg>
    </button>
    <h1>Thông tin tài khoản</h1>
    <form class="auth-form" id="userInfoForm">
      <div class="form-group">
        <label for="full-name">Họ và tên</label>
        <input type="text" name="full_name" id="full-name" class="form-input" placeholder="Nhập họ và tên của bạn" required>
      </div>
      <div class="form-group">
        <label for="dob">Ngày sinh</label>
        <input type="date" name="dob" id="dob" class="form-input" required>
      </div>
       <div class="form-group">
        <label for="email">Email</label>
        <input type="email" name="email" id="email" class="form-input" required>
      </div>
      <div id="user-info-message" class="form-message"></div>
      <button type="submit" class="btn-primary">Lưu thay đổi</button>
    </form>
  </section>
</div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    
    const navActions = document.querySelector('.nav-actions');

    fetch('check_login.php')
      .then(response => response.json())
      .then(data => {
        if (data.loggedin) {
          navActions.classList.remove('nav-actions--logged-out');
          navActions.classList.add('nav-actions--logged-in');
          navActions.querySelector('.btn-glass__label--user').textContent = data.username;
        } else {
          window.location.href = 'login.html?notice=upload';
        }
      })
      .catch(error => {
        console.error('Error checking login status:', error);
        window.location.href = 'login.html?notice=upload';
      });

    const userMenuBtn = document.getElementById('userMenuBtn');
    const userDropdown = document.getElementById('userDropdown');

    if(userMenuBtn && userDropdown) {
        userMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            userDropdown.classList.toggle('active');
        });
    }

    window.addEventListener('click', (e) => {
        if (userDropdown && !navActions.contains(e.target)) {
            userDropdown.classList.remove('active');
        }
    });

    const uploadForm = document.getElementById('uploadForm');
    const fileInput = document.getElementById('doc-file');
    const fileListContainer = document.getElementById('file-list-container');
    const customSelect = document.querySelector('.custom-select-wrapper');
    
    let fileStore = new DataTransfer();

    const renderFileList = () => {
      fileListContainer.innerHTML = '';
      if (fileStore.files.length === 0) return;

      Array.from(fileStore.files).forEach((file, index) => {
        const fileItemHTML = `
          <div class="file-list-item">
            <div class="file-info">
              <svg class="file-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" /></svg>
              <div class="file-details">
                <span class="file-name">${file.name}</span>
              </div>
            </div>
            <button type="button" class="file-remove-btn" data-index="${index}" aria-label="Xóa tệp ${file.name}">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
          </div>
        `;
        fileListContainer.insertAdjacentHTML('beforeend', fileItemHTML);
      });
    };

    fileInput.addEventListener('change', (e) => {
      const newFiles = e.target.files;
      for (const file of newFiles) {
        fileStore.items.add(file);
      }
      fileInput.files = fileStore.files;
      renderFileList();
    });

    fileListContainer.addEventListener('click', (e) => {
      const removeButton = e.target.closest('.file-remove-btn');
      if (removeButton) {
        const indexToRemove = parseInt(removeButton.dataset.index, 10);
        const newFiles = new DataTransfer();
        
        Array.from(fileStore.files).forEach((file, index) => {
          if (index !== indexToRemove) {
            newFiles.items.add(file);
          }
        });

        fileStore = newFiles;
        fileInput.files = fileStore.files;
        renderFileList();
      }
    });

    uploadForm.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const messageDiv = document.getElementById('upload-message');
      const submitButton = this.querySelector('button[type="submit"]');

      submitButton.disabled = true;
      submitButton.textContent = 'Đang tải lên...';
      messageDiv.style.display = 'none';

      fetch('upload.php', { method: 'POST', body: formData })
        .then(res => res.json())
        .then(data => {
            messageDiv.textContent = data.message;
            messageDiv.className = `form-message ${data.status}`;
            messageDiv.style.display = 'block';

            if (data.status === 'success') {
                submitButton.style.backgroundColor = '#2dcf6d';
                setTimeout(() => { window.location.href = 'index.html'; }, 2000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            messageDiv.textContent = 'Lỗi kết nối hoặc lỗi server.';
            messageDiv.className = 'form-message error';
            messageDiv.style.display = 'block';
        })
        .finally(() => {
            if (messageDiv.classList.contains('error')) {
                submitButton.disabled = false;
                submitButton.textContent = 'Tải lên';
            }
        });
    });

    if (customSelect) {
      const trigger = customSelect.querySelector('.custom-select-trigger');
      const options = customSelect.querySelectorAll('.custom-option');
      const originalSelect = document.getElementById('doc-category');

      trigger.addEventListener('click', () => { customSelect.classList.toggle('open'); });

      options.forEach(option => {
          option.addEventListener('click', () => {
              if (option.classList.contains('selected')) {
                  customSelect.classList.remove('open');
                  return;
              }
              options.forEach(opt => opt.classList.remove('selected'));
              option.classList.add('selected');
              trigger.querySelector('span').textContent = option.textContent;
              originalSelect.value = option.getAttribute('data-value');
              customSelect.classList.remove('open');
          });
      });

      window.addEventListener('click', (e) => {
          if (!customSelect.contains(e.target)) { customSelect.classList.remove('open'); }
      });
    }

    const openModal = (modalId) => {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        document.body.style.overflow = 'hidden';
        modal.style.display = 'flex';
        setTimeout(() => modal.classList.add('active'), 10);
    };

    const closeModal = (modalId) => {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        document.body.style.overflow = '';
        modal.classList.remove('active');
        setTimeout(() => {
            modal.style.display = 'none';
            const form = modal.querySelector('form');
            if (form) form.reset();
            const messageDiv = modal.querySelector('.form-message');
            if (messageDiv) {
                messageDiv.style.display = 'none';
                messageDiv.textContent = '';
                messageDiv.className = 'form-message';
            }
        }, 300);
    };
    
    document.querySelectorAll('[data-close-modal], .modal-overlay').forEach(el => {
        el.addEventListener('click', (e) => {
            if (e.target !== el && !e.target.closest('[data-close-modal]')) return;
            const modalId = el.dataset.closeModal || el.id;
            if (modalId) closeModal(modalId);
        });
    });
    
    document.querySelectorAll('.modal-overlay .auth-card').forEach(card => {
       card.addEventListener('click', e => e.stopPropagation());
    });

    document.getElementById('userInfoLink')?.addEventListener('click', (e) => {
        e.preventDefault();
        if (userDropdown) userDropdown.classList.remove('active');
        openModal('userInfoModalOverlay');
        fetch('get_user_info.php')
          .then(res => res.json())
          .then(data => {
              if(data.status === 'success') {
                  document.getElementById('full-name').value = data.data.full_name || '';
                  document.getElementById('dob').value = data.data.dob || '';
                  document.getElementById('email').value = data.data.email || '';
              }
          });
    });

    document.getElementById('changePasswordLink')?.addEventListener('click', (e) => {
        e.preventDefault();
        if (userDropdown) userDropdown.classList.remove('active');
        openModal('passwordModalOverlay');
    });

    const passwordChangeForm = document.getElementById('passwordChangeForm');
    if (passwordChangeForm) {
        passwordChangeForm.addEventListener('submit', function(e) { 
            e.preventDefault();
            const formData = new FormData(this);
            const messageDiv = document.getElementById('password-change-message');
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;

            submitButton.disabled = true;
            submitButton.textContent = 'Đang xử lý...';

            fetch('change_password.php', { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => {
                    messageDiv.textContent = data.message;
                    messageDiv.className = `form-message ${data.status}`;
                    if (data.status === 'success') {
                        setTimeout(() => closeModal('passwordModalOverlay'), 2000);
                    }
                })
                .catch(() => {
                    messageDiv.textContent = 'Lỗi kết nối. Vui lòng thử lại.';
                    messageDiv.className = 'form-message error';
                })
                .finally(() => {
                    if(messageDiv.classList.contains('error')){
                        submitButton.disabled = false;
                        submitButton.textContent = originalButtonText;
                    }
                });
        });
    }
    
    const userInfoForm = document.getElementById('userInfoForm');
    if (userInfoForm) {
        userInfoForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            const messageDiv = document.getElementById('user-info-message');
            const submitButton = this.querySelector('button[type="submit"]');
            const originalButtonText = submitButton.textContent;
            
            submitButton.disabled = true;
            submitButton.textContent = 'Đang lưu...';

            fetch('update_user_info.php', { method: 'POST', body: formData })
              .then(res => res.json())
              .then(data => {
                  messageDiv.textContent = data.message;
                  messageDiv.className = `form-message ${data.status}`;
                  if (data.status === 'success') {
                      setTimeout(() => closeModal('userInfoModalOverlay'), 2000);
                  }
              })
              .catch(() => {
                    messageDiv.textContent = 'Lỗi kết nối. Vui lòng thử lại.';
                    messageDiv.className = 'form-message error';
              })
              .finally(() => {
                  if(messageDiv.classList.contains('error')){
                      submitButton.disabled = false;
                      submitButton.textContent = originalButtonText;
                  }
              });
        });
    }

  });
</script>

</body>
</html>